{% extends 'invoice_manager/base.html' %}
{% load widget_tweaks %}

{% block content %}
  <div class="container">
    <div class="row justify-content-center">
  <!-- Form to add new item -->
  <div class="container">
    <div class="row justify-content-center">
      <h2 class="text-center">Add New Item</h2>
    </div>
    <div class="row justify-content-center">
      <form id="item-form" method="post" action="{% url 'invoice_manager:items' %}">
        {% csrf_token %}
        <div class="form-group">
          <label for="name">Item Name:</label>
          <input type="text" class="form-control" id="name" name="name" required>
        </div>
        <div class="form-group">
          <label for="rate">Rate:</label>
          <input type="number" class="form-control" id="rate" name="rate" required>
        </div>
        <button type="submit" class="btn btn-primary">Add Item</button>
      </form>
    </div>
      <div id="error-message" class="text-danger"></div>
  </div>
      <h1 class="text-center">Items</h1>
    </div>
    <div class="row justify-content-center">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Item Name</th>
            <th>Rate</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for item in items %}
            <tr data-item-id="{{ item.pk }}">
              <td>{{ item.name }}</td>
              <td>{{ item.rate }}</td>
              <td>
                <button class="btn btn-primary" data-toggle="modal" data-target="#update-modal-{{ item.pk }}">Update</button>
                <button class="btn btn-danger" data-toggle="modal" data-target="#delete-modal-{{ item.pk }}">Delete</button>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>


  <!-- Modal template -->
  {% for item in items %}
    <div id="delete-modal-{{ item.pk }}" class="modal fade">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Confirm Delete {{ item.name }}</h5>
            <button type="button" class="close" data-dismiss="modal">&times;</button>
          </div>
          <div class="modal-body">
            <p>Are you sure you want to delete {{ item.name }} from the list?</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirm-delete-{{ item.pk }}">Delete</button>
            <div id="loader-{{ item.pk }}" style="display: none;">
              <i class="fas fa-spinner fa-spin"></i>
            </div>
            <div id="error-message-{{ item.pk }}" style="display: none;"></div>
          </div>
        </div>
      </div>
    </div>

    <div id="update-modal-{{ item.pk }}" class="modal fade">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Update {{ item.name }}</h5>
            <button type="button" class="close" data-dismiss="modal">&times;</button>
          </div>
          <div class="modal-body">
            <form id="update-item-form-{{ item.pk }}">
              <div class="form-group">
                <label for="update-name-{{ item.pk }}">Item Name:</label>
                <input type="text" class="form-control" id="update-name-{{ item.pk }}" name="name" required value="{{ item.name }}">
              </div>
              <div class="form-group">
                <label for="update-rate-{{ item.pk }}">Rate:</label>
                <input type="number" class="form-control" id="update-rate-{{ item.pk }}" name="rate" required value="{{ item.rate }}">
              </div>
              <button type="submit" class="btn btn-primary">Update</button>
              <div id="loader-{{ item.pk }}" style="display: none;">
                <i class="fas fa-spinner fa-spin"></i>
              </div>
              <div id="error-message-{{ item.pk }}" style="display: none;"></div>
            </form>
          </div>
        </div>
      </div>
    </div>
  {% endfor %}

  <!-- JavaScript code -->
  <script>
    $(document).ready(function() {
      {% for item in items %}
        $('#confirm-delete-{{ item.pk }}').on('click', function() {
          var itemId = {{ item.pk }};
          var modalId = '#delete-modal-' + itemId;
          var loaderId = '#loader-' + itemId;
          var errorMessageId = '#error-message-' + itemId;

          $(loaderId).show();
          $(errorMessageId).hide();

          $.ajax({
            type: 'POST',
            url: '{% url 'invoice_manager:item_delete' item.pk %}',
              headers: {
                  'X-CSRFToken': '{{ csrf_token }}'
                },
            success: function(response) {
              if (response.success) {
                  console.log(response.success);
                $(modalId).modal('hide');
                // Update table to reflect deleted item
                $('tr[data-item-id="' + itemId + '"]').remove();
              } else {
                $(loaderId).hide();
                $(errorMessageId).html(response.error).show();
              }
            },
            error: function(xhr, status, error) {
              $(loaderId).hide();
              $(errorMessageId).html('Error: ' + error).show();
            }
          });
        });

        $('#update-item-form-{{ item.pk }}').on('submit', function(e) {
          e.preventDefault();
          var itemId = {{ item.pk }};
          var modalId = '#update-modal-' + itemId;
          var loaderId = '#loader-' + itemId;
          var errorMessageId = '#error-message-' + itemId;

          $(loaderId).show();
          $(errorMessageId).hide();

          $.ajax({
            type: 'POST',
            url: '{% url 'invoice_manager:item_update' item.pk %}',
              headers: {
                  'X-CSRFToken': '{{ csrf_token }}'
                },
            data: $(this).serialize(),
            success: function(response) {
              if (response.success) {
                  console.log(response.success);
                $(modalId).modal('hide');
                // Update table to reflect updated item
                $('tr[data-item-id="' + itemId + '"]').find('td:nth-child(1)').text(response.item.name);
                $('tr[data-item-id="' + itemId + '"]').find('td:nth-child(2)').text(response.item.rate);
                $(errorMessageId).html('').hide();
              } else {
                $(loaderId).hide();
                $(errorMessageId).html(response.error).show();
              }
            },
            error: function(xhr, status, error) {
              $(loaderId).hide();
              $(errorMessageId).html('Error: ' + error).show();
            }
          });
        });
      {% endfor %}
    });



    const form = document.querySelector('#item-form');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(form);
      const name = formData.get('name');
      const rate = formData.get('rate');
      const tableBody = document.querySelector('tbody');
      const existingRows = tableBody.rows;
      const errorMessageDiv = document.querySelector('#error-message');

      // Check for duplicate items
      for (let i = 0; i < existingRows.length; i++) {
        const rowName = existingRows[i].cells[0].textContent;
        const rowRate = existingRows[i].cells[1].textContent;
        if (rowName === name) {
          errorMessageDiv.textContent = `Error: Item with name "${name}" already exists.`;
          form.classList.add('error');
          return;
        }
      }

      try {
        const response = await fetch(form.action, {
          method: form.method,
          body: formData,
        });
        if (response.ok) {
          const newRow = document.createElement('tr');
          newRow.innerHTML = `
            <td>${name}</td>
            <td>${rate}</td>
            <td></td>
          `;
          tableBody.appendChild(newRow);
          form.reset();
          errorMessageDiv.textContent = '';
          form.classList.remove('error');
          window.location.href = window.location.href;
        } else if (response.status === 409) { // Conflict (Integrity Error)
          const errorText = await response.text();
          errorMessageDiv.textContent = `Error: ${errorText}`;
          form.classList.add('error');
        } else {
          errorMessageDiv.textContent = `Error: ${response.status} ${response.statusText}`;
          form.classList.add('error');
        }
      } catch (error) {
        console.error('Error submitting form:', error);
      }
    });
  </script>
{% endblock %}
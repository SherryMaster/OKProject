{% extends 'invoice_manager/base.html' %}

{% load widget_tweaks %}

{% block title %}Customers{% endblock %}

{% block content %}
  <div class="container">
    <h1 class="text-center">Customers</h1>
    <button type="button" class="btn red-button mt-3 mb-3" data-toggle="modal" data-target="#create-modal">Create New Customer</button>
    <div class="row justify-content-center">
      <table id="item-table" class="table table-striped">
        <thead>
          <tr>
            <th>Customer <input onkeyup="FilterList()" type="text" class="form-control" id="search-input" placeholder="Search..."></th>
            <th>Phone Number</th>
            <th>Address</th>
            <th>Pending Amount</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for customer in customers %}
            <tr data-customer-id="{{ customer.pk }}">
                <td>{{ customer.name }}</td>
                <td>{{ customer.phone_number }}</td>
                <td>{{ customer.address }}</td>
                <td>{{ customer.get_pending_amount }}</td>
                <td>
                <button class="btn btn-primary" onclick="onCustomerUpdateButtonClick({{ customer.pk }})"><i class="fas fa-edit"></i></button>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div id="modal-container">

    <div id="create-modal" class="modal fade">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Create New Customer</h5>
            <button type="button" class="close" data-dismiss="modal">&times;</button>
          </div>
          <div class="modal-body">
            <form id="create-item-form">
              <div class="form-group">
                <label for="name">Customer Name:</label>
                <input type="text" class="form-control" id="create-name" name="name" required>
              </div>
              <div class="form-group">
                <label for="phone_number">Phone Number:</label>
                <input type="text" class="form-control" id="create-phone_number" name="phone_number" required>
              </div>
              <div class="form-group">
                <label for="address">Address:</label>
                <input type="text" class="form-control" id="create-address" name="address">
              </div>
              <button type="submit" class="btn red-button" onclick="onCustomerCreateButtonClick()">Create</button>
              <div id="loader-create-modal" style="display: none;">
                <i class="fas fa-spinner fa-spin"></i>
              </div>
              <div id="create-modal-error-message" style="display: none;"></div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div id="update-modal" class="modal fade">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="update-modal-title">Update Customer</h5>
            <button type="button" class="close" data-dismiss="modal">&times;</button>
          </div>
          <div class="modal-body">
            <form id="update-customer-form">
              <div class="form-group">
                <label for="update-name">Customer Name:</label>
                <input type="text" class="form-control" id="update-name" name="name" required>
              </div>
              <div class="form-group">
                <label for="update-phone_number">Phone Number:</label>
                <input type="text" class="form-control" id="update-phone_number" name="phone_number" required>
              </div>
              <div class="form-group">
                <label for="update-address">Address:</label>
                <input type="text" class="form-control" id="update-address" name="address">
              </div>
                <button type="submit" class="btn btn-primary modal-update-button" id="confirm-update-customer" onclick="onCustomerModalUpdateButtonClick()" data-toggle="modal" data-target="#update-modal-{{ item.pk }}">Update</button>
                <div id="loader-update-modal" style="display: none;">
                  <i class="fas fa-spinner fa-spin"></i>
                </div>
                <div id="update-modal-error-message" style="display: none;"></div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

    <script>
    function onCustomerUpdateButtonClick(customerId) {
        var item = $('tr[data-customer-id="' + customerId + '"]');
        var modal = $('#update-modal');
        var name = item.find('td:nth-child(1)').text();
        var phone_number = item.find('td:nth-child(2)').text();
        var address = item.find('td:nth-child(3)').text();
        modal.find('#update-name').val(name);
        modal.find('#update-phone_number').val(phone_number);
        modal.find('#update-address').val(address);
        modal.find('#loader-update-modal').hide();
        modal.find('#update-modal-error-message').hide();
        modal.find('#update-modal-title').text(`Update ${name}`);
        modal.find('#update-modal-confirm-message').text(`Are you sure you want to update ${name}?`);
        modal.find('#confirm-update-customer').data('customer-id', customerId);
        modal.modal('show');
    }

    function onCustomerModalUpdateButtonClick(){
        var customerId = $('#confirm-update-customer').data('customer-id');

        var customer = $('tr[data-customer-id="' + customerId + '"]');
        var name = $('#update-name').val();
        var phone_number = $('#update-phone_number').val();
        var address = $('#update-address').val();
        var modal = '#update-modal';
        var loaderId = '#loader-update-modal';
        var errorMessageId = '#update-modal-error-message';

        if (name === '' || phone_number === '') {
          $(loaderId).hide();
          $(errorMessageId).html('Name and phone number are required').show();
          return;
        }
        $.ajax({
          type: 'POST',
          url: `customers/${customerId}/update`,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
              },
          data: {
            'name': name,
            'phone_number': phone_number,
            'address': address
          },
          beforeSend: function() {
            $(loaderId).show();
            $(errorMessageId).hide();
          },
          success: function(response) {
            if (response.success) {
              $(modal).modal('hide');
              $(loaderId).hide();
              $(errorMessageId).hide();
              // Update table to reflect updated item
              customer.find('td:nth-child(1)').text(response.customer.name);
              customer.find('td:nth-child(2)').text(response.customer.phone_number);
              customer.find('td:nth-child(3)').text(response.customer.address);
            } else {
              $(loaderId).hide();
              if (response.reason) {
                $(errorMessageId).html(response.reason).show();
              } else {
                $(errorMessageId).html(response.error).show();
              }
            }
          },
          error: function(xhr, status, error) {
            $(loaderId).hide();
            $(errorMessageId).html('Error: ' + error).show();
          }
        });
    }


    function onCustomerCreateButtonClick() {
        $('#create-modal-title').text('Create Customer');
        var modal = $('#create-modal');
        var loaderId = '#loader-create-modal';
        var errorMessageId = '#create-modal-error-message';
        var name = $('#create-name').val();
        var phone_number = $('#create-phone_number').val();
        var address = $('#create-address').val();

        if (name === '' || phone_number === '') {
          $(loaderId).hide();
          $(errorMessageId).html('Name and phone number are required').show();
          return;
        }
        $.ajax({
          type: 'POST',
          url: '{% url 'invoice_manager:customer_create' %}',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
              },
          data: {
            'name': name,
            'phone_number': phone_number,
            'address': address
          },
          beforeSend: function() {
            $(loaderId).show();
            $(errorMessageId).hide();
          },
          success: function(response) {
            if (response.success) {
                modal.modal('hide');
                $(loaderId).hide();
                $(errorMessageId).hide();
                // Update table to reflect updated item
                var newRow = $('<tr>');
                newRow.attr('data-customer-id', response.customer.pk);
                newRow.append('<td>' + response.customer.name + '</td>');
                newRow.append('<td>' + response.customer.phone_number + '</td>');
                newRow.append('<td>' + response.customer.address + '</td>');
                newRow.append('<td>' + response.customer.pending_amount + '</td>');
                newRow.append('<td><button class="btn btn-primary" onclick="onCustomerUpdateButtonClick(' + response.customer.pk + ')"><i class="fas fa-edit"></i></button></td>');
              $('#item-table tbody').append(newRow);
            } else {
              $(loaderId).hide();
              if (response.reason) {
                $(errorMessageId).html(response.reason).show();
              } else {
                $(errorMessageId).html(response.error).show();
              }
            }
          },
          error: function(xhr, status, error) {
            $(loaderId).hide();
            $(errorMessageId).html('Error: ' + error).show();
          }
        });
    }

    $('#update-customer-form').on('submit', function(e) {
        e.preventDefault();
    });
    $('#create-item-form').on('submit', function(e) {
        e.preventDefault();
    });
    </script>

{% endblock %}